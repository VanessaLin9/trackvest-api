datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  admin
  user
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  role         UserRole  @default(user)
  createdAt    DateTime  @default(now())
  accounts     Account[]
  tags         Tag[]
  glAccounts   GlAccount[] @relation("UserToGlAccounts")
  glEntries    GlEntry[]   @relation("UserToGlEntries")
}

model Account {
  id        String        @id @default(uuid())
  userId    String
  name      String
  type      AccountType
  currency  Currency
  createdAt DateTime      @default(now())
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  positions Position[]
  txs       Transaction[]
  glAccount GlAccount?    @relation("AccountToGlAccount")

  @@index([userId])
}

enum Currency {
  TWD
  USD
  JPY
  EUR
}

enum AccountType {
  broker
  bank
  cash
}

model Asset {
  id           String        @id @default(uuid())
  symbol       String        @unique
  name         String
  type         AssetType
  baseCurrency String
  prices       Price[]
  positions    Position[]
  txs          Transaction[]
}

enum AssetType {
  equity
  etf
  crypto
  cash
}

model Transaction {
  id        String   @id @default(uuid())
  accountId String
  assetId   String?
  type      TxType
  amount    Decimal
  quantity  Decimal?
  price     Decimal?
  fee       Decimal  @default(0)
  tradeTime DateTime
  note      String?

  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  asset   Asset?  @relation(fields: [assetId], references: [id])
  tags    TxTag[]

  @@index([accountId, isDeleted, tradeTime])
  @@index([assetId, isDeleted, tradeTime])
  @@index([type])
}

enum TxType {
  buy
  sell
  deposit
  withdraw
  dividend
  fee
}

model Price {
  id      String   @id @default(uuid())
  assetId String
  price   Decimal
  asOf    DateTime
  source  String
  asset   Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, asOf(sort: Desc)])
}

model FxRate {
  id    String   @id @default(uuid())
  base  String
  quote String
  rate  Decimal
  asOf  DateTime

  @@index([base, quote, asOf(sort: Desc)])
}

model Tag {
  id     String  @id @default(uuid())
  userId String
  name   String
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  txs    TxTag[]

  @@unique([userId, name])
  @@index([userId])
}

model TxTag {
  transactionId String
  tagId         String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  tag           Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([transactionId, tagId])
  @@index([tagId])
}

model Position {
  id        String    @id @default(uuid())
  accountId String
  assetId   String
  quantity  Decimal   @default(0)
  avgCost   Decimal   @default(0)
  openedAt  DateTime
  closedAt  DateTime?
  account   Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  asset     Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([accountId, assetId])
}

// ç§‘ç›®è¡¨ï¼ˆChart of Accountsï¼‰
model GlAccount {
  id              String         @id @default(uuid())
  userId          String
  code            String?        // æ–¹ä¾¿æ’åº/åŒ¯å‡ºï¼ˆå¯é¸ï¼‰
  name            String
  type            GlAccountType  // asset | liability | equity | income | expense
  currency        Currency?      // è‹¥æŒ‡å®šï¼Œè©²ç§‘ç›®åªå…è¨±æ­¤å¹£åˆ¥
  linkedAccountId String?        // å°æ‡‰ä½ ç¾æœ‰çš„ Accountï¼ˆéŠ€è¡Œ/åˆ¸å•†/ç¾é‡‘ç­‰ï¼‰
  archivedAt      DateTime?

  // ğŸ”» æ”¹ï¼šåŠ  relation nameï¼Œä¸¦å°æ‡‰ä¸Šé¢ User/Account çš„åå‘æ¬„ä½
  user    User     @relation("UserToGlAccounts", fields: [userId], references: [id], onDelete: Cascade)
  linked  Account? @relation("AccountToGlAccount", fields: [linkedAccountId], references: [id])

  // ğŸ”» æ–°å¢ï¼šè¢« GlLine æŒ‡åˆ°çš„åå‘æ¬„ä½
  lines   GlLine[]

  @@unique([userId, name])
  @@index([userId, type])
  @@unique([linkedAccountId])
}

enum GlAccountType { 
  asset 
  liability 
  equity 
  income 
  expense 
}

// åˆ†éŒ„ä¸»è¡¨ï¼ˆæ¯ä¸€å¼µæ†‘è­‰ï¼‰
model GlEntry {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime
  memo      String?
  source    String?  // 'manual' | 'auto:transaction:<txId>' | 'auto:transfer:<id>'...
  refTxId   String?  // é¸é…ï¼šå°æ‡‰æŠ•è³‡ Transaction.id
  isDeleted Boolean  @default(false)
  deletedAt DateTime?

  // ğŸ”» æ”¹ï¼šåŠ  relation nameï¼Œå°æ‡‰ä¸Šé¢ User.glEntries
  user   User     @relation("UserToGlEntries", fields: [userId], references: [id], onDelete: Cascade)
  lines  GlLine[]

  @@index([userId, date])
  @@index([refTxId])

  // ï¼ˆå¯é¸ï¼‰è‹¥è¦ä¿è­‰ refTxId åœ¨åŒä¸€ user ä¸‹å”¯ä¸€ï¼ˆè‡ªå‹•éå¸³å†ªç­‰ï¼‰
  // @@unique([userId, refTxId])
}

// åˆ†éŒ„æ˜ç´°ï¼ˆå¿…é ˆå€Ÿè²¸ç›¸ç­‰ï¼›ç¬¬ä¸€ç‰ˆå»ºè­°ã€ŒåŒä¸€åˆ†éŒ„åŒä¸€å¹£åˆ¥ã€ï¼‰
model GlLine {
  id          String    @id @default(uuid())
  entryId     String
  glAccountId String
  amount      Decimal   // æ­£æ•¸é‡‘é¡
  side        GlSide    // debit or credit
  currency    Currency  // ç¬¬ä¸€ç‰ˆç°¡åŒ–ï¼šåŒä¸€ entry å…¨éƒ¨åŒä¸€ currency
  note        String?

  entry    GlEntry    @relation(fields: [entryId], references: [id], onDelete: Cascade)
  glAccount GlAccount @relation(fields: [glAccountId], references: [id], onDelete: Cascade)

  @@index([entryId])
  @@index([glAccountId])
   // ï¼ˆå¯é¸ï¼‰æŸ¥é¤˜é¡å¸¸ç”¨ï¼š
  @@index([glAccountId, currency])
}

enum GlSide { 
  debit 
  credit 
}
