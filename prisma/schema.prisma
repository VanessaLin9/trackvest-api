datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  admin
  user
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  role         UserRole  @default(user)
  createdAt    DateTime  @default(now())
  accounts     Account[]
  tags         Tag[]
}

model Account {
  id        String        @id @default(uuid())
  userId    String
  name      String
  type      AccountType
  currency  String
  createdAt DateTime      @default(now())
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  positions Position[]
  txs       Transaction[]

  @@index([userId])
}

enum AccountType {
  broker
  bank
  cash
}

model Asset {
  id           String        @id @default(uuid())
  symbol       String        @unique
  name         String
  type         AssetType
  baseCurrency String
  prices       Price[]
  positions    Position[]
  txs          Transaction[]
}

enum AssetType {
  equity
  etf
  crypto
  cash
}

model Transaction {
  id        String   @id @default(uuid())
  accountId String
  assetId   String?
  type      TxType
  amount    Decimal
  quantity  Decimal?
  price     Decimal?
  fee       Decimal  @default(0)
  tradeTime DateTime
  note      String?

  isDeleted Boolean   @default(false)
  deletedAt DateTime?

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  asset   Asset?  @relation(fields: [assetId], references: [id])
  tags    TxTag[]

  @@index([accountId, isDeleted, tradeTime])
  @@index([assetId, isDeleted, tradeTime])
  @@index([type])
}

enum TxType {
  buy
  sell
  deposit
  withdraw
  dividend
  fee
}

model Price {
  id      String   @id @default(uuid())
  assetId String
  price   Decimal
  asOf    DateTime
  source  String
  asset   Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, asOf(sort: Desc)])
}

model FxRate {
  id    String   @id @default(uuid())
  base  String
  quote String
  rate  Decimal
  asOf  DateTime

  @@index([base, quote, asOf(sort: Desc)])
}

model Tag {
  id     String  @id @default(uuid())
  userId String
  name   String
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  txs    TxTag[]

  @@unique([userId, name])
  @@index([userId])
}

model TxTag {
  transactionId String
  tagId         String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  tag           Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([transactionId, tagId])
  @@index([tagId])
}

model Position {
  id        String    @id @default(uuid())
  accountId String
  assetId   String
  quantity  Decimal   @default(0)
  avgCost   Decimal   @default(0)
  openedAt  DateTime
  closedAt  DateTime?
  account   Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  asset     Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([accountId, assetId])
}
